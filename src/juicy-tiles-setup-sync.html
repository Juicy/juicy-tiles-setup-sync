<!--
    Polymer Element to handle `<juicy-tile-list>` (or `-grid`) setup changes (staging, reverting, saving to storage).
-->
<!-- Import Polymer -->
<!-- <link rel="import" href="../../polymer/polymer.html"> -->
<!-- Define your custom element -->
<dom-module id="juicy-tiles-setup-sync">
    <template>
        <style>
            :host {
                display: none;
            }
        </style>
    </template>
    <script>
        Polymer({
            is: "juicy-tiles-setup-sync",
            properties: {
                storedValue: { type: Object, value: null, observer: "storedValueChanged" },
                currentValue: { type: Object },
                autoSave: { type: Boolean },
                name: { type: String },
                apiUrl: { type: String, value: "/juicytilessetup" },
                tileList: { type: Object, value: null },
            },
            attached: function () {
                globme = this;
                this.tileList = this.nextElementSibling;
                this.tileList.sync = this;
            },
            detached: function () {
                delete this.tileList.sync;
                this.tileList = null;
                // this.currentValue = null;
            },
            save: function () {
                this.storedValue = JSON.parse(JSON.stringify(this.tileList.setup));

                // FIXME: temporary workaround for servers not accepting JSON-Patch
                var req = new XMLHttpRequest();
                req.open("POST", this.apiUrl + "?" + this.name, true);
                req.onreadystatechange = function () {
                    if (req.readyState == 4) {
                        if (!(req.status >= 200 && req.status <= 299)) {
                            console.error("Failed to save juicy-tile-list configuration");
                            return;
                        }
                        console.info("juicy-tile-list configuration saved");
                    }
                };
                return req.send(JSON.stringify(this.storedValue));
            },
            revert: function () {
                this.tileList.setup = this.storedValue && JSON.parse(JSON.stringify(this.storedValue));
            },
            /**
             * Resets the current value.
             */
            clear: function () {
                if (this.storedValue === null) {
                    this.storedValueChanged(null, null);
                } else {
                    this.storedValue = null;
                }
            },
            isModified: function () {
                return JSON.stringify(this.storedValue) != JSON.stringify(this.tileList.setup);
            },
            storedValueChanged: function (oldVal, newVal) {
                if (this.tileList) {
                    var newJson = JSON.stringify(newVal);
                    if (JSON.stringify(this.tileList.setup) != newJson) {
                        this.tileList.setup = JSON.parse(newJson);
                    }
                    console.log("storedValueChanged", oldVal, newVal);
                }
            }
        });
    </script>
</dom-module>